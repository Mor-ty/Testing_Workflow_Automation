name: Execute JMeter Test (HAR → JMX → Load Test)

on:
  workflow_dispatch:
    inputs:
      har_file:
        description: "Path of the HAR file in your repo"
        required: true
        type: string
      users:
        description: "Number of users (max 3)"
        required: true
        default: 1
      iterations:
        description: "Number of iterations (max 3)"
        required: true
        default: 1
      constant_time:
        description: "Constant think time (ms)"
        required: true
        default: 1000
      random_time:
        description: "Random time (ms)"
        required: true
        default: 10000
      random_time_variance:
        description: "Variance (ms)"
        required: true
        default: 3000

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:

    # Step 1: Checkout
    - name: Checkout Repo
      uses: actions/checkout@v4

    # Step 2: Download HAR file from GitHub workflow input
    - name: Download HAR from repo path
      run: |
        echo "HAR FILE: ${{ github.event.inputs.har_file }}"
        cp "${{ github.workspace }}/${{ github.event.inputs.har_file }}" ./input.har

    # Step 3: Setup Java
    - name: Install Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # Step 4: Download HAR→JMX JAR
    - name: Download HAR Converter Plugin
      run: |
        git clone https://github.com/vdaburon/har-to-jmeter-convertor.git
        cd har-to-jmeter-convertor
        mvn clean package
        ls -l target/
    # Step 5: Convert HAR → JMX
    - name: Convert HAR to JMX
      run: |
        cd har-to-jmeter-convertor
        java -cp target/har-to-jmeter-convertor-7.0-jar-with-dependencies.jar \
          io.github.vdaburon.jmeter.har.HarConvertorIntegrate \
          -har_in ../../input.har \
          -jmx_out ../../generated_test.jmx \
          -add_pause true \
          -new_tc_pause 3000
        cd ../
        ls -l generated_test.jmx

    # Step 6: Validate JMX output
    - name: Validate JMX Output
      run: |
        if [ ! -s generated_test.jmx ]; then
          echo "❌ ERROR: JMX file is empty. Conversion failed."
          exit 1
        fi
        echo "JMX validation OK."

    # Step 7: Setup Docker
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    # Step 8: Enforce Limits
    - name: Enforce Limits
      run: |
        u=${{ github.event.inputs.users }}
        i=${{ github.event.inputs.iterations }}
        if [ "$u" -gt 3 ]; then u=3; fi
        if [ "$i" -gt 3 ]; then i=3; fi
        echo "users=$u" >> $GITHUB_ENV
        echo "iterations=$i" >> $GITHUB_ENV

    # Step 9: Run JMeter Load Test
    - name: Run JMeter Test
      run: |
        mkdir -p results
        docker run --rm \
          -v ${{ github.workspace }}:/jmeter \
          -v ${{ github.workspace }}/results:/results \
          -w /jmeter justb4/jmeter:5.5 \
          -n -t generated_test.jmx -l ./results/results.jtl \
          -Jusers=${{ env.users }} \
          -Jiterations=${{ env.iterations }} \
          -Jconstant_time=${{ github.event.inputs.constant_time }} \
          -Jrandom_time=${{ github.event.inputs.random_time }} \
          -Jrandom_time_variance=${{ github.event.inputs.random_time_variance }}

    # Step 10: Generate HTML report
    - name: Generate JMeter Report
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/jmeter \
          -v ${{ github.workspace }}/results:/results \
          -w /jmeter justb4/jmeter:5.5 \
          -g ./results/results.jtl -o ./results/report

    # Step 11: Upload report
    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: JMeter-Report
        path: ./results/report
